import{r as v,j as e}from"./ui-BW6CElO3.js";import{u as N}from"./useQuery-BXIAm6IW.js";import{d as D,u as L,e as T,f as $,g as P,B as i,P as w,p as x,C,a as F,h as I,b as M,M as V}from"./index-Dc-q1J-l.js";import{f as p,a as A}from"./categories-Ci5EyH-Y.js";import{B as E}from"./badge-CjM9ThMm.js";import{M as R}from"./mission-detail-modal-D6vY5X2-.js";import{C as H}from"./circle-alert-D7x-0abh.js";import{E as K}from"./eye-Bn-3ZOuO.js";import{S as Q}from"./square-pen-UN0Hl2qH.js";import{T as O}from"./trash-2-qRCZZsZx.js";import{C as U,H as W}from"./hand-CxDNhhNz.js";import"./vendor-D3F3s8fL.js";import"./textarea-DlZPPU9w.js";import"./tabs-BJBN-kmm.js";import"./availability-calendar-DKIoBrE4.js";import"./calendar-BAJX1a1J.js";import"./chevron-left-amD_TAmK.js";import"./clock-AUiFetKH.js";import"./save-D0JsyXx0.js";import"./map-pin-CpnFbaGb.js";import"./calendar-C1ybr4we.js";import"./message-circle-B0H4q3yu.js";import"./phone-DeghlA_h.js";import"./award-CZ01pAm2.js";import"./star-BF6ZaPE7.js";import"./circle-check-big-Dntu27NV.js";import"./circle-x-CUl-L6Nq.js";import"./smart-bid-analyzer-mYZlIC93.js";import"./triangle-alert-DRwr2r9q.js";import"./lightbulb-CaEC0r6U.js";import"./trending-up-CXxgtGH6.js";import"./euro-hWitNI0P.js";import"./user-check-Df1DJA0u.js";function ke(){const{user:t}=D(),[,l]=L(),[o,u]=v.useState("posted"),[h,f]=v.useState(null),k=T(),{toast:b}=$(),{data:m=[],isLoading:g,error:S}=N({queryKey:["userMissions",t?.id],queryFn:async()=>{if(!t?.id)throw new Error("User ID manquant");console.log("🔍 Récupération des missions pour user.id:",t.id);const s=await fetch(`/api/missions/users/${t.id}/missions`);if(!s.ok){const a=await s.text();throw console.error("❌ Erreur API missions:",s.status,a),new Error(`Erreur ${s.status}: ${a}`)}const r=await s.json();console.log("✅ Missions récupérées:",r.length);const n=await Promise.all(r.map(async a=>{try{const c=await fetch(`/api/missions/${a.id}`);if(c.ok){const z=await c.json();return{...a,bids:z.bids||[]}}return{...a,bids:[]}}catch(c){return console.error(`Erreur récupération offres mission ${a.id}:`,c),{...a,bids:[]}}}));return console.log("✅ Missions avec offres:",n.length),n},enabled:!!t?.id,retry:2,retryDelay:1e3}),{data:d=[],isLoading:j}=N({queryKey:["userBids",t?.id],queryFn:async()=>{const s=await fetch(`/api/missions/users/${t?.id}/bids`);if(!s.ok)throw new Error("Failed to fetch user bids");return s.json()},enabled:!!t&&t.type==="provider"}),y=P({mutationFn:async s=>{const r=await fetch(`/api/missions/${s}`,{method:"DELETE"});if(!r.ok)throw new Error("Failed to delete mission");return r.json()},onSuccess:()=>{k.invalidateQueries({queryKey:["userMissions"]}),b({title:"Mission supprimée",description:"Votre mission a été supprimée avec succès."})},onError:s=>{b({title:"Erreur",description:"Impossible de supprimer la mission.",variant:"destructive"})}}),q=s=>{window.confirm("Êtes-vous sûr de vouloir supprimer cette mission ?")&&y.mutate(s)},B=s=>{const r={published:{label:"Publiée",variant:"default"},open:{label:"Ouverte",variant:"default"},in_progress:{label:"En cours",variant:"secondary"},completed:{label:"Terminée",variant:"outline"},closed:{label:"Fermée",variant:"destructive"}},n=r[s]||r.published;return e.jsx(E,{variant:n.variant,children:n.label})};return console.log("👤 User actuel:",{id:t?.id,type:t?.type,name:t?.name}),console.log("🔗 Mapping: user.id =",t?.id,"| client_id attendu:",t?.id),t?e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-8",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-6 sm:mb-8",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-gray-900 mb-1 sm:mb-2",children:"Mes Missions"}),e.jsx("p",{className:"text-base sm:text-lg text-gray-600",children:"Gérez vos missions et consultez les offres reçues"})]}),e.jsxs(i,{onClick:()=>l(x.createMission),size:"lg",className:"w-full sm:w-auto",children:[e.jsx(w,{className:"mr-2 h-4 w-4 sm:h-5 sm:w-5"}),"Nouvelle Mission"]})]}),e.jsx("div",{className:"border-b border-gray-200 mb-8",children:e.jsxs("nav",{className:"-mb-px flex space-x-6 sm:space-x-8",children:[e.jsxs("button",{onClick:()=>u("posted"),className:`py-2 px-1 border-b-2 font-medium text-sm sm:text-base ${o==="posted"?"border-primary text-primary":"border-transparent text-gray-500 hover:text-gray-700"}`,children:["Missions publiées (",m.length,")"]}),t.type==="provider"&&e.jsxs("button",{onClick:()=>u("bids"),className:`py-2 px-1 border-b-2 font-medium text-sm sm:text-base ${o==="bids"?"border-primary text-primary":"border-transparent text-gray-500 hover:text-gray-700"}`,children:["Mes candidatures (",d.length,")"]})]})}),(g||j)&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500",children:"Chargement..."})]}),S&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(H,{className:"w-16 h-16 text-red-300 mx-auto mb-4"}),e.jsx("p",{className:"text-red-500 text-lg mb-4",children:"Erreur de chargement"}),e.jsx(i,{onClick:()=>window.location.reload(),variant:"outline",children:"Réessayer"})]}),o==="posted"&&!g&&e.jsx("div",{className:"space-y-6",children:m.length>0?m.map(s=>e.jsxs(C,{className:"hover:shadow-lg transition-shadow",children:[e.jsx(F,{children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-start gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx(I,{className:"text-xl",children:s.title}),B(s.status||"published")]}),e.jsx("p",{className:"text-gray-600 text-sm sm:text-base",children:s.description})]}),e.jsxs("div",{className:"text-left sm:text-right",children:[e.jsx("div",{className:"text-xl font-bold text-primary",children:p(s.budget||"0")}),e.jsx("div",{className:"text-sm text-gray-500 mt-1",children:A(s.createdAt)})]})]})}),e.jsxs(M,{children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-x-4 gap-y-2 text-sm text-gray-600",children:[e.jsxs("span",{children:["Catégorie: ",s.category]}),e.jsxs("span",{children:["Lieu: ",s.location||"Non spécifié"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(V,{className:"w-4 h-4"}),e.jsxs("span",{children:[s.bids?.length||0," offre",(s.bids?.length||0)!==1?"s":""]})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(i,{variant:"outline",size:"sm",onClick:()=>f(s.id?.toString()||null),className:"flex items-center gap-1",children:[e.jsx(K,{className:"w-4 h-4"}),"Voir les offres"]}),e.jsxs(i,{variant:"outline",size:"sm",onClick:()=>l(x.editMission(s.id?.toString()||"")),className:"flex items-center gap-1",children:[e.jsx(Q,{className:"w-4 h-4"}),"Modifier"]}),e.jsxs(i,{variant:"outline",size:"sm",onClick:()=>q(s.id),className:"flex items-center gap-1 text-red-600 hover:text-red-700",disabled:y.isPending,children:[e.jsx(O,{className:"w-4 h-4"}),"Supprimer"]})]})]}),s.bids&&s.bids.length>0&&e.jsxs("div",{className:"mt-4 pt-4 border-t border-gray-200",children:[e.jsx("p",{className:"text-sm font-medium text-gray-700 mb-2",children:"Dernières offres reçues :"}),e.jsxs("div",{className:"space-y-2",children:[s.bids.slice(0,2).map(r=>e.jsxs("div",{className:"flex justify-between items-center text-sm bg-gray-50 p-2 rounded",children:[e.jsx("span",{className:"truncate flex-1",children:r.proposal}),e.jsx("span",{className:"font-medium text-primary ml-2",children:p(r.price)})]},r.id)),s.bids.length>2&&e.jsxs("p",{className:"text-xs text-gray-500",children:["+",s.bids.length-2," autre",s.bids.length-2>1?"s":""," offre",s.bids.length-2>1?"s":""]})]})]})]})]},s.id)):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(U,{className:"w-16 h-16 text-gray-300 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500 text-lg mb-4",children:"Vous n'avez pas encore publié de missions"}),e.jsxs(i,{onClick:()=>l(x.createMission),className:"bg-primary hover:bg-primary-dark text-white",children:[e.jsx(w,{className:"w-4 h-4 mr-2"}),"Créer ma première mission"]})]})}),o==="bids"&&t.type==="provider"&&!j&&e.jsx("div",{className:"space-y-6",children:d.length>0?d.map(s=>e.jsx(C,{className:"hover:shadow-lg transition-shadow",children:e.jsxs(M,{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Candidature soumise"}),e.jsx("p",{className:"text-gray-600 mb-4 text-sm sm:text-base",children:s.proposal}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-500",children:"Votre offre:"}),e.jsx("span",{className:"text-xl font-bold text-primary ml-2",children:p(s.price)})]}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("span",{className:"text-sm text-gray-500",children:["Délai: ",s.timeline]}),e.jsx(E,{variant:"secondary",children:"En attente"})]})]})]})},s.id)):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(W,{className:"w-16 h-16 text-gray-300 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500 text-lg mb-4",children:"Vous n'avez pas encore postulé à des missions"}),e.jsx(i,{onClick:()=>l("/marketplace"),className:"bg-primary hover:bg-primary-dark text-white",children:"Découvrir les missions"})]})}),e.jsx(R,{missionId:h,isOpen:!!h,onClose:()=>f(null)})]}):e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-4",children:"Connexion requise"}),e.jsx("p",{className:"text-gray-600 mb-8",children:"Veuillez vous connecter pour voir vos missions"}),e.jsx(i,{onClick:()=>l("/"),children:"Retour à l'accueil"})]})})}export{ke as default};
